<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Rails Controller Specs Don't Always Play Nice With Hashie &#8211; Ryan Oglesby</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdn.mathjax.org">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="My thoughts and experiences as I navigate the world of Agile software development.">
    <meta name="robots" content="all">
    <meta name="author" content="Ryan Oglesby">
    
    <meta name="keywords" content="rails, hashie, rspec, testing">
    <link rel="canonical" href="http://ryanogles.by/rails/hashie/rspec/testing/2012/12/26/rails-controller-specs-dont-always-play-nice-with-hashie.html">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Ryan Oglesby" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/assets/css/styles.css?201611041654" type="text/css">
    <link href='/stylesheets/all-e96e70bbb78ca0af094b24259e4b32a9.css' media='all' rel='stylesheet' type='text/css'>

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Open+Sans:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Rails Controller Specs Don't Always Play Nice With Hashie">
    <meta property="og:description" content="A problem and solution for an issue I encountered while using Hashie + ActionController + Rspec in Rails 3">
    <meta property="og:url" content="http://ryanogles.by/rails/hashie/rspec/testing/2012/12/26/rails-controller-specs-dont-always-play-nice-with-hashie.html">
    <meta property="og:site_name" content="Ryan Oglesby">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@ryanoglesby08" />
    
    <meta name="twitter:title" content="Rails Controller Specs Don't Always Play Nice With Hashie" />
    <meta name="twitter:description" content="My thoughts and experiences as I navigate the world of Agile software development." />
    <meta name="twitter:url" content="http://ryanogles.by/rails/hashie/rspec/testing/2012/12/26/rails-controller-specs-dont-always-play-nice-with-hashie.html" />

    
    <script type="text/javascript">
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-51481422-1', 'auto');
       ga('send', 'pageview');
    </script>
    
</head>
<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://ryanogles.by" class="site-title">Ryan Oglesby</a>
      <nav class="site-nav">
        <a href="/about.html">Me</a>
<a href="/oss.html">OSS</a>
      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/ryanoglesby08"></a>
    
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/ryanoglesby08"></a>
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:ryan.oglesby08@gmail.com"></a>
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>
      
    </div>
  </div>
</header>

    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Rails Controller Specs Don't Always Play Nice With Hashie</h1>
  <span class="post-meta">Dec 26, 2012</span><br>
  
  <span class="post-meta small">
  
    3 minute read
  
  </span>
</div>

<article class="post-content">
  <h2 id="hashie-and-rspec---the-problem">Hashie and Rspec - The Problem:</h2>
<p><a href="https://github.com/intridea/hashie">Hashie</a> is a neat little Ruby gem that extends Hash and gives object-like access and functionality to hashes.  Classes can extend from Hashie and add other functionality as needed. It is especially useful when marshaling JSON or XML data from a service layer into your business models.</p>

<p>While Hashie is very useful, we have to be careful using this gem with ActionController Rspec tests.  When creating the <code class="highlighter-rouge">assigns</code> hash used in controller tests, Rspec creates a <code class="highlighter-rouge">HashWithIndifferentAccess</code>, which is dangerous with objects that act like Hash (such as Hashie objects). Rspec ends up converting user-defined objects that inherit from Hashie into <code class="highlighter-rouge">HashWithIndifferentAccess</code> objects, causing us to lose any data that exists outside of the backing hash.</p>

<!-- more -->

<h2 id="the-setup">The Setup:</h2>
<p>Lets imagine our Rails application talks to an Employee API exposing JSON data.  We have already implemented the service layer that makes the API call and returns Employee objects that extend Hashie.  In the EmployeeController we make the service call and assign the resulting Employee object.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">employee.rb</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">Hashie</span><span class="o">::</span><span class="no">Dash</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">property</span> <span class="ss">:first_name</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">property</span> <span class="ss">:last_name</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="c1"># foo is not specified using "property" because it does not come from the EmployeeService</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="c1">#   JSON response. We are separating what comes from the service and what does not.</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="kp">attr_accessor</span> <span class="ss">:foo</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">end</span></div></div></pre></div></figure>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">employee_controller.rb</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">class</span> <span class="nc">EmployeeController</span> <span class="o">&lt;</span> <span class="no">ActionController</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="k">def</span> <span class="nf">show</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="vi">@employee</span> <span class="o">=</span> <span class="no">EmployeeService</span><span class="p">.</span><span class="nf">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="vi">@employee</span><span class="p">.</span><span class="nf">foo</span> <span class="o">=</span> <span class="s1">'extra info'</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="k">end</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">end</span></div></div></pre></div></figure>

<h2 id="the-tests-where-the-conflict-occurs">The Tests (Where the conflict occurs):</h2>
<p>We should be able to write some simple specs to test the controller, specifically, that the result of the service call is stored in the correct variable passed into the view and that we assign whatever extra processing we need to do outside of the service layer into “foo.”</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">employee_controller_spec.rb</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">require</span> <span class="s1">'spec_helper'</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">describe</span> <span class="no">EmployeeController</span> <span class="k">do</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">describe</span> <span class="s1">'show'</span> <span class="k">do</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">it</span> <span class="s1">'should assign the employee'</span> <span class="k">do</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="no">EmployeeService</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:find_by_id</span><span class="p">)</span> <span class="p">&#x7b;</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">new</span> <span class="p">&#x7d;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">id: </span><span class="s1">'employee_id'</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">assigns</span><span class="p">[</span><span class="ss">:employee</span><span class="p">].</span><span class="nf">should</span> <span class="n">be_an</span> <span class="no">Employee</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">assigns</span><span class="p">[</span><span class="ss">:employee</span><span class="p">].</span><span class="nf">foo</span><span class="p">.</span><span class="nf">should</span> <span class="o">==</span> <span class="s1">'extra info'</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">end</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="k">end</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">end</span></div></div></pre></div></figure>

<p>You would assume this test would pass right? Nope! Fail!</p>

<p>The output of both assertions would be:</p>
<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">expected</span> <span class="p">&#x7b;</span><span class="s2">"first_name"</span><span class="o">=&gt;</span><span class="s2">"John"</span><span class="p">,</span> <span class="s2">"last_name"</span><span class="o">=&gt;</span><span class="s2">"Smith"</span><span class="p">&#x7d;</span> <span class="n">to</span> <span class="n">be</span> <span class="n">a</span> <span class="n">kind</span> <span class="n">of</span> <span class="no">Employee</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="no">NoMethodError</span><span class="p">:</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="s1">'foo'</span> <span class="k">for</span> <span class="p">&#x7b;</span><span class="s2">"first_name"</span><span class="o">=&gt;</span><span class="s2">"John"</span><span class="p">,</span> <span class="s2">"last_name"</span><span class="o">=&gt;</span><span class="s2">"Smith"</span><span class="p">&#x7d;</span><span class="ss">:ActiveSupport</span><span class="o">::</span><span class="no">HashWithIndifferentAccess</span></div></div></pre></div></figure>

<p>As you can see, Rails has converted our Employee object into a <a href="http://api.rubyonrails.org/classes/ActiveSupport/HashWithIndifferentAccess.html">HashWithIndifferentAccess</a>! How dare you Rails?!</p>

<h2 id="why-would-rails-do-this">Why would Rails do this?</h2>
<p>Well, don’t be too quick to point the finger, this is actually a combination of Rspec and Rails (ActiveSupport). Rspec is trying to make it easier for you to use the ActionController <code class="highlighter-rouge">view_assigns</code> hash by converting it into a <code class="highlighter-rouge">HashWithIndifferentAccess</code>.  Diving into <code class="highlighter-rouge">ActionDispatch::TestProcess</code> we find the method definition for <code class="highlighter-rouge">assigns</code>:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">test_process.rb</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">module</span> <span class="nn">ActionDispatch</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="k">module</span> <span class="nn">TestProcess</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">assigns</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">assigns</span> <span class="o">=</span> <span class="vi">@controller</span><span class="p">.</span><span class="nf">view_assigns</span><span class="p">.</span><span class="nf">with_indifferent_access</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">key</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="n">assigns</span> <span class="p">:</span> <span class="n">assigns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">end</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">.</span><span class="nf">.</span><span class="o">.</span></div></div></pre></div></figure>

<p>The easy access to the <code class="highlighter-rouge">view_assigns</code> hash is great, but looking deeper into the internals of the <code class="highlighter-rouge">with_indifferent_access</code> method we find that while creating the <code class="highlighter-rouge">HashWithIndifferentAccess</code>, any assigns variable that is a <code class="highlighter-rouge">Hash</code> is converted into a <code class="highlighter-rouge">HashWithIndifferentAccess</code>! Since Hashie classes return true when asked if they are a <code class="highlighter-rouge">Hash</code>, they also get converted, therefore, losing their original object identity. To me ActiveSupport is stepping over the line here. Yes, give us easy access to the assigns hash, but don’t mess with the actual values of that hash unless I tell you to.</p>

<h2 id="easy-workaround">Easy workaround:</h2>
<p>First, this problem is unique to Rspec tests - production code does not have this same problem. One solution would be to monkey patch <code class="highlighter-rouge">ActiveSuport::TestProcess</code> and <code class="highlighter-rouge">ActiveSupport::HashWithIndifferentAccess</code>. But, since I try to stay away from monkey patching whenever possible, the quick solution is just to not use <code class="highlighter-rouge">assigns</code> when your object under test is a Hash and you care about it not being converted to a <code class="highlighter-rouge">HashWithIndifferentAccess</code> for testing purposes.</p>

<p>Instead, use the controller’s <code class="highlighter-rouge">view_assigns</code> hash directly to avoid the conversion to <code class="highlighter-rouge">HashWithIndifferentAccess</code>:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">employee_controller_spec.rb</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">require</span> <span class="s1">'spec_helper'</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">describe</span> <span class="no">EmployeeController</span> <span class="k">do</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">describe</span> <span class="s1">'show'</span> <span class="k">do</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">it</span> <span class="s1">'should assign the employee'</span> <span class="k">do</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="no">EmployeeService</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:find_by_id</span><span class="p">)</span> <span class="p">&#x7b;</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">new</span> <span class="p">&#x7d;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">id: </span><span class="s1">'employee-id'</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="c1"># Can not use assigns[:employee] here because Employee inherits from Hashie</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">controller</span><span class="p">.</span><span class="nf">view_assigns</span><span class="p">[</span><span class="s1">'employee'</span><span class="p">].</span><span class="nf">should</span> <span class="n">be_an</span> <span class="no">Employee</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">controller</span><span class="p">.</span><span class="nf">view_assigns</span><span class="p">[</span><span class="s1">'employee'</span><span class="p">].</span><span class="nf">foo</span><span class="p">.</span><span class="nf">should</span> <span class="o">==</span> <span class="s1">'extra info'</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">end</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="k">end</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">end</span></div></div></pre></div></figure>

<p>In the end, its an easy workaround for a slightly annoying “feature” of Rspec.</p>

</article>


  <div class="share-page">
  Share me:

  <div class="share-links ml1">
    
      <a class="fa fa-facebook" href="https://facebook.com/sharer.php?u=http://ryanogles.by/rails/hashie/rspec/testing/2012/12/26/rails-controller-specs-dont-always-play-nice-with-hashie.html" rel="nofollow" target="_blank" title="Share on Facebook"></a>
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=Rails Controller Specs Don't Always Play Nice With Hashie&url=http://ryanogles.by/rails/hashie/rspec/testing/2012/12/26/rails-controller-specs-dont-always-play-nice-with-hashie.html" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    

    
      <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=http://ryanogles.by/rails/hashie/rspec/testing/2012/12/26/rails-controller-specs-dont-always-play-nice-with-hashie.html&title=Rails Controller Specs Don't Always Play Nice With Hashie" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    

    

    

    

    

    
      <a class="fa fa-hacker-news" onclick="parent.postMessage('submit','*')" href="https://news.ycombinator.com/submitlink?u=http://ryanogles.by/rails/hashie/rspec/testing/2012/12/26/rails-controller-specs-dont-always-play-nice-with-hashie.html&t=Rails Controller Specs Don't Always Play Nice With Hashie" rel="nofollow" target="_blank" title="Share on Hacker News"></a>
    
  </div>
</div>





  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname  = 'ryanoglesby';
    var disqus_identifier = '/rails/hashie/rspec/testing/2012/12/26/rails-controller-specs-dont-always-play-nice-with-hashie';
    var disqus_title      = "Rails Controller Specs Don't Always Play Nice With Hashie";

    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).<br>
      &lt;/&gt; available on <a href="https://github.com/johnotander/pixyll">Github</a>.
    </small>
  </div>
</footer>
</body>
</html>
